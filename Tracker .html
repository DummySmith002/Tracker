<!DOCTYPE html><html lang="zh-Hant"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>終極版軌跡記錄工具</title>
    
    <!-- Leaflet.js 地圖函式庫 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Leaflet-image 匯出地圖圖片的函式庫 -->
    <script src="https://unpkg.com/leaflet-image@0.4.0/dist/leaflet-image.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --start-bg: #28a745;
            --stop-bg: #dc3545;
            --mark-bg: #ffc107;
            --mark-text: #212529;
            --light-gray: #f8f9fa;
        }
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            display: flex;
            flex-direction: column;
        }
        .header {
            background-color: #fff;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            z-index: 1001;
            flex-shrink: 0;
        }
        .container { display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        h1 { margin: 0; font-size: 20px; color: #333; }
        .controls { display: flex; gap: 10px; }
        .btn {
            padding: 10px 15px; font-size: 14px; border: none; border-radius: 5px;
            cursor: pointer; transition: background-color 0.3s; color: white;
            font-weight: bold; white-space: nowrap;
        }
        .btn-start { background-color: var(--start-bg); }
        .btn-stop { background-color: var(--stop-bg); }
        .btn-mark { background-color: var(--mark-bg); color: var(--mark-text); }
        .btn:disabled { background-color: #6c757d; cursor: not-allowed; }
        
        #map { flex-grow: 1; width: 100%; z-index: 1; }
        
        .info-panel {
            height: 35%; max-height: 280px; background-color: #fff;
            overflow-y: auto; padding: 15px; border-top: 1px solid #ddd;
            box-sizing: border-box; flex-shrink: 0; display: flex; flex-direction: column;
        }
        .info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;}
        h2 { margin: 0; font-size: 18px; }
        #logContainer { flex-grow: 1; overflow-y: auto; }
        #logList { list-style-type: none; padding: 0; margin: 0; font-size: 13px; font-family: 'Courier New', Courier, monospace; }
        #logList li { padding: 6px 5px; border-bottom: 1px solid #eee; }
        #logList li.stop-start { background-color: #fff3cd; color: #664d03; }
        #logList li.stop-end { background-color: #d1e7dd; font-weight: bold; color: #0f5132; }
        
        #exportControls { display: none; gap: 8px; flex-wrap: wrap; }
        .export-btn { background-color: var(--primary-color); font-size: 12px; padding: 8px 12px;}
    </style>
</head>
<body>

    <div class="header">
        <div class="container">
            <h1>軌跡記錄工具</h1>
            <div class="controls">
                <button id="trackingBtn" class="btn btn-start">開始追蹤</button>
                <button id="markStopBtn" class="btn btn-mark" disabled="">標記停留</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <div class="info-panel">
        <div class="info-header">
            <h2>詳細記錄</h2>
            <div id="exportControls">
                <button id="exportCsvBtn" class="btn export-btn">匯出 CSV</button>
                <button id="exportGpxBtn" class="btn export-btn">匯出 GPX</button>
                <button id="exportPngBtn" class="btn export-btn">匯出地圖</button>
            </div>
        </div>
        <div id="logContainer">
            <ul id="logList">
                <li>點擊「開始追蹤」以記錄您的軌跡...</li>
            </ul>
        </div>
    </div>

    <script>
        // --- DOM 元素 ---
        const trackingBtn = document.getElementById('trackingBtn');
        const markStopBtn = document.getElementById('markStopBtn');
        const exportControls = document.getElementById('exportControls');
        const logList = document.getElementById('logList');

        // --- 應用程式狀態 ---
        let isTracking = false, isCurrentlyStopped = false;
        let watchId = null, map = null, polyline = null;
        let trackPoints = [], logData = [];
        let manualStopInfo = null;

        // --- 地圖初始化 ---
        map = L.map('map').setView([25.034, 121.564], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- 事件監聽 ---
        trackingBtn.addEventListener('click', toggleTracking);
        markStopBtn.addEventListener('click', toggleManualStop);
        document.getElementById('exportCsvBtn').addEventListener('click', exportCSV);
        document.getElementById('exportGpxBtn').addEventListener('click', exportGPX);
        document.getElementById('exportPngBtn').addEventListener('click', exportPNG);

        // --- 核心功能 ---
        function toggleTracking() {
            if (!isTracking) { // 開始
                if (!navigator.geolocation) { return alert("您的瀏覽器不支援地理定位功能。"); }
                
                // 重設一切
                isTracking = true;
                trackPoints = [];
                logData = [];
                logList.innerHTML = '<li>正在啟動追蹤...</li>';
                if (polyline) map.removeLayer(polyline);
                map.eachLayer(layer => { if (layer instanceof L.Marker) map.removeLayer(layer); });

                trackingBtn.textContent = '結束追蹤';
                trackingBtn.className = 'btn btn-stop';
                markStopBtn.disabled = false;
                exportControls.style.display = 'none';

                watchId = navigator.geolocation.watchPosition(handlePositionUpdate, handleLocationError, { enableHighAccuracy: true });
            } else { // 結束
                if (watchId !== null) navigator.geolocation.clearWatch(watchId);
                if (isCurrentlyStopped) toggleManualStop(); // 自動結束最後的停留

                isTracking = false;
                watchId = null;
                trackingBtn.textContent = '開始追蹤';
                trackingBtn.className = 'btn btn-start';
                markStopBtn.disabled = true;
                exportControls.style.display = 'flex';
                addLog({ type: 'Info', message: '追蹤已結束。' });
            }
        }

        function toggleManualStop() {
            if (!isTracking) return;
            if (!isCurrentlyStopped) { // 開始停留
                isCurrentlyStopped = true;
                markStopBtn.textContent = '結束停留';
                navigator.geolocation.getCurrentPosition(pos => {
                    const { latitude, longitude } = pos.coords;
                    manualStopInfo = { lat: latitude, lng: longitude, startTime: new Date() };
                    const log = { type: '停留開始', time: manualStopInfo.startTime, lat: latitude, lng: longitude };
                    addLog(log, 'stop-start');
                    manualStopInfo.marker = L.marker([latitude, longitude]).addTo(map)
                        .bindPopup(`<b>停留中...</b><br>開始: ${formatTime(manualStopInfo.startTime)}`).openPopup();
                    map.panTo([latitude, longitude]);
                }, handleLocationError);
            } else { // 結束停留
                const endTime = new Date();
                const durationMs = endTime - manualStopInfo.startTime;
                const durationStr = formatDuration(durationMs);
                const log = {
                    type: '停留結束', time: endTime, lat: manualStopInfo.lat, lng: manualStopInfo.lng,
                    duration: durationStr, startTime: manualStopInfo.startTime
                };
                addLog(log, 'stop-end');
                manualStopInfo.marker.bindPopup(`<b>停留點</b><br>時長: ${durationStr}<br>從: ${formatTime(manualStopInfo.startTime)}<br>到: ${formatTime(endTime)}`).openPopup();
                
                isCurrentlyStopped = false;
                manualStopInfo = null;
                markStopBtn.textContent = '標記停留';
            }
        }

        function handlePositionUpdate(position) {
            if (isCurrentlyStopped) return;
            const { latitude, longitude } = position.coords;
            const now = new Date();
            const point = { lat: latitude, lng: longitude, time: now };

            if (trackPoints.length === 0) {
                logList.innerHTML = '';
                map.setView([latitude, longitude], 16);
            }
            trackPoints.push(point);
            updateMap(point);
            addLog({ type: '移動', time: now, lat: latitude, lng: longitude });
        }

        function updateMap(point) {
            const pathPoints = trackPoints.map(p => [p.lat, p.lng]);
            if (!polyline) {
                polyline = L.polyline(pathPoints, { color: 'blue' }).addTo(map);
            } else {
                polyline.setLatLngs(pathPoints);
            }
            map.panTo([point.lat, point.lng]);
        }
        
        // --- 匯出功能 ---
        function exportCSV() {
            let csvContent = "時間,類型,緯度,經度,停留時長(秒)\n";
            logData.forEach(log => {
                const time = log.time ? log.time.toISOString() : '';
                const lat = log.lat ? log.lat.toFixed(6) : '';
                const lng = log.lng ? log.lng.toFixed(6) : '';
                let durationSec = '';
                if (log.type === '停留結束') {
                    durationSec = Math.round((log.time - log.startTime) / 1000);
                }
                csvContent += `${time},${log.type},${lat},${lng},${durationSec}\n`;
            });
            triggerDownload(csvContent, 'tracker_log.csv', 'text/csv;charset=utf-8;');
        }

        function exportGPX() {
            let gpxContent = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1" creator="Ultimate Tracker" xmlns="http://www.topografix.com/GPX/1/1">
  <trk>
    <name>軌跡記錄</name>
    <trkseg>\n`;
            trackPoints.forEach(p => {
                gpxContent += `      <trkpt lat="${p.lat}" lon="${p.lng}"><time>${p.time.toISOString()}</time></trkpt>\n`;
            });
            gpxContent += `    </trkseg>
  </trk>
</gpx>`;
            triggerDownload(gpxContent, 'tracker_route.gpx', 'application/gpx+xml');
        }

        function exportPNG() {
            leafletImage(map, function(err, canvas) {
                if(err) {
                    alert('匯出圖片失敗：' + err);
                    return;
                }
                const a = document.createElement('a');
                a.href = canvas.toDataURL('image/png');
                a.download = 'tracker_map.png';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            });
        }

        // --- 輔助函式 ---
        function addLog(log, className = '') {
            logData.push(log);
            const li = document.createElement('li');
            if(className) li.className = className;
            let text = `[${log.type}]`;
            if(log.time) text += ` ${formatTime(log.time)}`;
            if(log.lat) text += ` @ ${log.lat.toFixed(4)},${log.lng.toFixed(4)}`;
            if(log.duration) text += ` (共 ${log.duration})`;
            if(log.message) text = log.message;
            li.textContent = text;
            logList.insertBefore(li, logList.firstChild);
        }

        function triggerDownload(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function handleLocationError(error) { alert(`定位錯誤: ${error.message}`); if (isTracking) toggleTracking(); }
        function formatTime(date) { return date.toLocaleTimeString('zh-TW'); }
        function formatDuration(ms) {
            let s = Math.floor(ms / 1000);
            let m = Math.floor(s / 60);
            let h = Math.floor(m / 60);
            s %= 60; m %= 60;
            return [h, m, s].map(v => v.toString().padStart(2, '0')).join(':');
        }
    </script>


</body></html>